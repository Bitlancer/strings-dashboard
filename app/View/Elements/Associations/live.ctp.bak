<?php

	if(!isset($emptyTableMessage))
		$emptyTableMessage = 'Add a member above';

    if(!isset($addInputPlaceholder))
        $addInputPlaceholder = 'name';

    if(!isset($tableColumnHeaders))
        $tableColumnHeaders = array('Name');

	$tableValues = array();
	foreach($memberData as $member){
		$tableRow = array();
		$tableRow[0] = $member['displayValue'];
		$tableRow[0] .= "<a class=\"action remove\" data-id=\"" . $member['id'] . "\">Remove</a>";
		$tableValues[] = $tableRow;
	}
?>
<div class="association" 
        data-src-add="<?php echo $addAssociationUri; ?>" 
        data-src-remove="<?php echo $removeAssociationUri; ?>" 
        data-empty-table-msg="<?php echo $emptyTableMessage; ?>">
  <div id="add">
    <input class="add autocomplete disable-autosubmit" type="text" placeholder="<?php echo $addInputPlaceholder; ?>" data-src="<?php echo $addAutocompleteUri; ?>" />
    <a class="cta primary small add">Add</a>
    <hr class="clear" />
  </div>
  <?php echo $this->StringsTable->cleanTable($tableColumnHeaders,$tableValues,$emptyTableMessage); ?>
  <hr class="clear" />
</div>
<script>
  $("div.association input[type='text']").keypress(function(e){
    if(e.which == 13){
      $(this).closest("div").find(".cta.add").click();
    }
  });
  $('div.association .cta.add').live('click',function(e){
    e.preventDefault();
    var src = $(this);
    var container = src.closest('div.association');
    var input = container.find('input');
    var name = input.val();
    var notice = container.find("#notice");
    notice.empty();
    $.ajax({
      type: "post",
      url: div.attr('data-src-add'),
      data: {
        "name": name
      },
      success: function(data, textStatus){
        if(!data.isError){
          var tbody = container.find("table tbody");
          $(tbody).find('td.blank').parent('tr').remove();
          var element = "<tr><td>";
          element += name;
          element += "<a class='action remove' data-id='" + data.id + "'>Remove</a>";
          element += "</td></tr>";
          $(tbody).append(element);
          input.val("");
        }
        else {
          notice.append("<li class='error'>" + data.message + "</li>");
        }
      }
    })
    .error(function(jqXHR,textStatus){
      console.log(textStatus);
    });
  });
  $('div.association .action.remove').live('click',function(e){
    e.preventDefault();
    var src = $(this);
    var container = src.closest('div.association');
    var notice = div.find("#notice");
    notice.empty();
    $.ajax({
      type: "post",
      url: container.attr('data-src-remove'),
      data: {
        "id": src.attr('data-id')
      },
      success: function(data, textStatus){
        var tbody = src.closest('tbody');
        src.closest('tr').remove();
        if(tbody.find('tr').length == 0){
          tbody.append("<tr><td class='blank'>" + container.attr('data-empty-table-msg') + "</td></tr>");
        }
      }
    })
    .error(function(jqXHR,textStatus){
      console.log(textStatus);
    });
  });
</script>
